{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block styles %}
{% endblock %}

{% block navigation %}
    <li class="nav-list-item"><a class="nav-list-link" href="{{ url_for('auth.logout') }}">Sign Out</a></li>
    <li class="nav-list-item"><a class="nav-list-link" href="{{ url_for('pages.add') }}">Store a Username and Password</a></li>
    <li class="nav-list-item"><a class="nav-list-link" href="{{ url_for('pages.update') }}">Update</a></li>
    {% endblock %}

{% block content %}
<div class="dashboard">
    <div class="service-list">
        <ul>
            {% if not services %}
            Looks like there's nothing here! Click "Store a Username and Password" to get started.
            {% endif %}
            {% for service in services %}
            <li class="service-item">
                <div class="service-details">
                    <h3 class="service-name">{{ service['service_name'] }}</h3>
                    <p class="service-username">Username: {{ service['service_username'] }}</p>
                    <span id="password_{{ service['service_id'] }}" class="service-password">Password Hidden</span>
                    <p class="service-url">Service URL: <a href="{{ service['service_url'] }}" target="_blank" class="service-url-link">{{ service['service_url'] }}</a></p>
                    <button onclick="showPassword({{ service['service_id'] }})" class="btn-show">Show Password</button>
                    <button onclick="hidePassword({{ service['service_id'] }})" class="btn-show">Hide Password</button>
                    <button onclick="update({{ service['service_id'] }})">Update</button>
                    <button onclick="remove({{ service['service_id'] }})">Remove</button>
                </div>
                {% if not loop.last %}
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
    // Fetch decrypted password
    function showPassword(serviceId) {
    fetch(`/decrypt/${serviceId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById(`password_${serviceId}`).textContent = data.password;
        });
    }

    // Hide decrypted password
    function hidePassword(serviceId) {
        document.getElementById(`password_${serviceId}`).textContent = "Password Hidden";
    }

    // Store a service_id in the session and redirect to update form
    function update(serviceId) {
        // Create a form to send the selected service_id to the backend
        var formdata = new FormData();
        formdata.append('service_id', serviceId);

        // Fetch the endpoint
        fetch('/process-service-id', {
            method: 'POST',
            body: formdata,
        }) // Process the response from the server, ensure status is ok
        .then( response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json;
        }) // Handle data 
        .then(data => {
            console.log('Success', data);
            // Redirect to update form page
            window.location.href = "{{ url_for('pages.update') }}";
        })
    }

    // Remove a Service
    function remove(serviceId) {
        var formdata = new FormData();
        formdata.append('service_id', serviceId);

        fetch('/remove-service', {
            method: 'POST',
            body: formdata,
        })
        .then( response => {
            if (!response.ok) {
                throw new Error('Network response was not OK. ' + response.statusText);
            }
            return response.json;
        })
        .then( data => {
            console.log('success', data);
            window.location.reload();
        })
    }
</script>
{% endblock %}